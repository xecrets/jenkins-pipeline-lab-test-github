// slackUserIdsString = ""

pipeline {
    triggers { pollSCM('* * * * *') }
    options { timestamps() }
    agent {
        node {
            label 'master'
            customWorkspace "/workspace/jenkins-pipeline-lab-test-github/master"
        }
    }
    stages {
        stage('Checkout') {
			steps {
				dir('test') {
					// git branch: "master", url: 'https://github.com/xecrets/jenkins-pipeline-lab-test-github.git'
				}
			}
		}
		stage ('Do something') {
			steps {
				script {
					bat "exit 0"
				}
			}
		}
    }
	post {
		always {
			emailext body: 'A Test EMail',
				recipientProviders: [[$class: 'DevelopersRecipientProvider']/*, [$class: 'RequesterRecipientProvider']*/],
				subject: 'Test'

			// Testing availability of changeSets
			script {
				// def slackUserIds = []
				def changeLogSets = currentBuild.changeSets
				for (int i = 0; i < changeLogSets.size(); i++) {
					def entries = changeLogSets[i].items
					for (int j = 0; j < entries.length; j++) {
						def entry = entries[j]
						echo "${entry.commitId} by ${entry.author} on ${new Date(entry.timestamp)}: ${entry.msg}"
						def emailAddress = entry.author.getProperty(hudson.tasks.Mailer.UserProperty.class).getAddress()
						echo "email = ${emailAddress}"
						def userId = slackUserIdFromEmail(emailAddress)
						echo "userId = ${userId}"
						// slackUserIds.add(userId)

						def files = new ArrayList(entry.affectedFiles)
						for (int k = 0; k < files.size(); k++) {
							def file = files[k]
							echo "  ${file.editType.name} ${file.path}"
						}
					}
				}
				// def userIdsString = slackUserIds.collect { "<@$it>" }.join(' ')
			}
		}
		success {
			script {
				def userId = slackUserIdFromEmail('svante@axantum.com')
                echo userId
				// def slackUserIds = slackUserIdsFromCommitters()
				def slackUserIds = [userId]
				// echo "${slackUserIds}"
				def userIdsString = slackUserIds.collect { "<@$it>" }.join(' ')
				echo "${userIdsString}"
				//def userIdsString = ""

				slackSend color: "good", message: "${userIdsString} Pipeline Testing indicates a SUCCESSFUL build.", notifyCommitters: true
			}
		}
		regression {
			script {
				// def userIds = slackUserIdsFromCommitters()
				// bat echo "${userIds}"
				//def userIdsString = userIds.collect { "<@$it>" }.join(' ')
				def userIdsString = ""

				if (currentBuild.result == 'UNSTABLE') {
					slackSend color: "warning", message: "${userIdsString} Pipeline Testing indicates regression to an UNSTABLE build.", notifyCommitters: false
				}
				if (currentBuild.result == 'FAILURE') {
					slackSend color: "danger", message: "${userIdsString} Pipeline Testing indicates regression to a FAILED build.", notifyCommitters: false
				}
			}
		}
		failure {
			script {
				// def userIds = slackUserIdsFromCommitters()
				// bat echo "${userIds}"
				//def userIdsString = userIds.collect { "<@$it>" }.join(' ')
				def userIdsString = ""

				if (currentBuild.result == 'UNSTABLE') {
					slackSend color: "warning", message: "${userIdsString} Pipeline Testing indicates an UNSTABLE build.", notifyCommitters: false
				}
				if (currentBuild.result == 'FAILURE') {
					slackSend color: "danger", message: "${userIdsString} Pipeline Testing indicates a FAILED build.", notifyCommitters: false
				}
			}
		}
	}
}